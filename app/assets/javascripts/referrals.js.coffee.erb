# facebookToken = '<%# app.current_user.authorizations.last.oauth_token %>'
window.referrals =
  ajax:
    createReferral: (args) ->
      utils.ajax
        type: 'POST'
        url: '<%= Weave::Application.routes.url_helpers.referrals_path %>'
        data: args

    updateReferral: (args) ->
      utils.put
        url: '<%= Weave::Application.routes.url_helpers.referrals_path %>/1'
        data: args

  friends: null
  nameAutoComplete: ->
    @friends ||= facebook.query("/me/friends").then( (results) ->
      results.data.map (item) ->
        {label: item.name, value: item}
      # results.map (item) ->
        # {
    )

  nameFilter: (term, name) ->
    terms = term.trim().split(/\s+/)
    regexs = (new RegExp "\\b#{term}", "i" for term in terms)
    regexs.every (regex) -> regex.test name

  initBindings: ->

    # TODO(syu): mix in gmail
    $("#name-or-email").autocomplete
      select: (event, ui) ->
        # Fill in the input fields
        $("#name-or-email").val ui.item.label
        $("#fb-uid").val ui.item.value.id
        $("#fb-uinfo").val JSON.stringify(ui.item.value.info)
        # Prevent the value from being inserted in "#name"
        false
      minLength: 2
      source: (request, response) ->
        referrals.nameAutoComplete().then (results) ->
          filtered = results.filter (e) -> referrals.nameFilter(request.term, e.label)
          filtered.map (e) ->
            facebook.query("#{e.value.id}?fields=location,education,political").done( (results) ->
              e.value["info"] = results
            )
          response(filtered)

        ###
        #(request, add) ->
        $this = $(@)
        # accessToken = response.authResponse.accessToken
        tokenUrl = "https://graph.facebook.com/me/friends?access_token=" + facebookToken + "&callback=?"

        # Call out to the Graph API for the friends list
        tokenUrl =
        $.ajax
          url: tokenUrl
          dataType: "jsonp"
          success: (results) ->
            console.log results
            # Filter the results and return a label/value object array
            formatted = []
            i = 0
            while i < results.data.length
              if results.data[i].name.toLowerCase().indexOf($("#name-or-email").val().toLowerCase()) >= 0
                formatted.push
                  label: results.data[i].name
                  value: results.data[i].id
              i++
            add formatted
          error: (results) ->
            console.log results
            ####



jQuery ->
  referrals.initBindings()




###
$ ->
  # Depends on: jQuery, jQuery UI core & widgets (for the autocomplete method)
  # Assumes you're already including the FB JS SDK asynchronously...
  window.fbAsyncInit = ->
    FB.init
      appId: "xxxxxxxxxxxxxxxxxx" # App ID
      status: true # check login status
      cookie: true # enable cookies to allow the server to access the session
      oauth: true
      xfbml: true

    FB.getLoginStatus (response) ->
      if response.authResponse # if the user is authorized...
        accessToken = response.authResponse.accessToken
        tokenUrl = "https://graph.facebook.com/me/friends?access_token=" + accessToken + "&callback=?"

        # Place <input id="name" /> and <input id="fbuid" /> into HTML


      ###
